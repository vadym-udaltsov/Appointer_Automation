AWSTemplateFormatVersion: 2010-09-09
Resources:
#Lambdas
  AdminLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          Ref: DeploymentBucket
        S3Key: !Join [ "", [ !Ref AdminLambdaArtifact, !Ref ArtifactSuff ] ]
      FunctionName:
        Ref: AdminLambdaName
      Handler: com.bot.lambda.AdminLambda::handleRequest
      Layers:
        - !Ref AdminLayer
      MemorySize: 1024
      Role: !GetAtt AdminLambdaRole.Arn
      SnapStart:
        ApplyOn: PublishedVersions
      Runtime: java11
      Environment:
        Variables:
          ACCOUNT: !Ref AccountId
      Timeout: 300
    DependsOn:
      - AdminLayer
  RegisterBotLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          Ref: DeploymentBucket
        S3Key: pythonLambdasPackage.zip
      FunctionName: !Ref RegisterBotLambdaName
      Handler: FunctionHandler.lambda_handler
      MemorySize: 512
      Role: !GetAtt AdminLambdaRole.Arn
      Runtime: python3.7
      Timeout: 60
    DependsOn:
      - AdminLambdaRole
  PostSignUpPythonLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          Ref: DeploymentBucket
        S3Key: pythonLambdasPackage.zip
      FunctionName: !Ref PostSignUpLambdaName
      Handler: PostSignUpHandler.lambda_handler
      MemorySize: 512
      Role: !GetAtt AdminLambdaRole.Arn
      Runtime: python3.7
      Timeout: 30
      Environment:
        Variables:
          accountId: !Ref AccountId
    DependsOn:
      - AdminLambdaRole
  BotLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          Ref: DeploymentBucket
        S3Key: !Join [ "", [ !Ref BotLambdaArtifact, !Ref ArtifactSuff ] ]
      FunctionName:
        Ref: BotLambdaName
      Handler: com.bot.lambda.BotLambda::handleRequest
      Layers:
        - !Ref AdminLayer
      MemorySize: 512
      Role: !GetAtt AdminLambdaRole.Arn
      SnapStart:
        ApplyOn: PublishedVersions
      Runtime: java11
      Timeout: 300
      Environment:
        Variables:
          ACCOUNT: !Ref AccountId
    DependsOn:
      - AdminLayer
#Lambda versions
  AdminLambdaVersion:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName:
        Ref: AdminLambdaName
    DependsOn:
      - AdminLambda
  AdminLambdaAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName:
        Ref: AdminLambdaName
      FunctionVersion: !GetAtt AdminLambdaVersion.Version
      Name: !Join [ "", [ !Ref AdminLambdaName, "Alias" ] ]
    DependsOn:
      - AdminLambdaVersion
  BotLambdaVersion:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName:
        Ref: BotLambdaName
    DependsOn:
      - BotLambda
  BotLambdaAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName:
        Ref: BotLambdaName
      FunctionVersion: !GetAtt BotLambdaVersion.Version
      Name: !Join [ "", [ !Ref BotLambdaName, "Alias" ] ]
    DependsOn:
      - BotLambdaVersion
#Lambda permissions
  AdminLambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: AdminLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: admin_lambda_policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:*'
                  - 'ssm:*'
                  - 's3:*'
                  - 'sqs:*'
                  - 'polly:*'
                  - 'transcribe:*'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'logs:CreateLogStream'
                  - 'logs:CreateLogGroup'
                  - 'logs:PutLogEvents'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'cognito-identity:*'
                  - 'cognito-idp:*'
                  - 'cognito-sync:*'
                  - 'iam:ListRoles'
                  - 'iam:ListOpenIdConnectProviders'
                  - 'iam:GetRole'
                  - 'iam:ListSAMLProviders'
                  - 'iam:GetSAMLProvider'
                  - 'kinesis:ListStreams'
                  - 'lambda:GetPolicy'
                  - 'lambda:ListFunctions'
                  - 'sns:GetSMSSandboxAccountStatus'
                  - 'sns:ListPlatformApplications'
                  - 'ses:ListIdentities'
                  - 'ses:GetIdentityVerificationAttributes'
                  - 'ses:VerifyEmailIdentity'
                  - 'ses:VerifyDomainDkim'
                  - 'ses:VerifyDomainIdentity'
                  - 'mobiletargeting:GetApps'
                  - 'acm:ListCertificates'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                Resource: 'arn:aws:s3:::*transcribe*'
              - Effect: Allow
                Action:
                  - 'translate:*'
                  - 'comprehend:DetectDominantLanguage'
                  - 's3:ListAllMyBuckets'
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 'iam:ListRoles'
                  - 'iam:GetRole'
                Resource: '*'
  PostSignUpLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PostSignUpLambdaName
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Join [ "", [ "arn:aws:cognito-idp:", !Ref Region, ":", !Ref AccountId, ":userpool/", !Ref UserPool ] ]
    DependsOn:
      - UserPool
#Layer
  AdminLayer:
    Type: 'AWS::Lambda::LayerVersion'
    Properties:
      CompatibleRuntimes:
        - java11
      Content:
        S3Bucket:
          Ref: DeploymentBucket
        S3Key:
          Ref: LayerFileName
      Description: Bot lambdas 3rd party dependencies.
      LayerName:
        Ref: LayerName
#S3 buckets
  StaticWebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref UiBucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      OwnershipControls:
        Rules:
          - ObjectOwnership: ObjectWriter
      WebsiteConfiguration:
        IndexDocument: login.html
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - '*'
            AllowedMethods:
              - GET
            MaxAge: 3000
  LocalizationBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join [ "", [ "appointer-localization-", !Ref AccountId ] ]
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StaticWebsiteBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub 'arn:aws:s3:::${StaticWebsiteBucket}/*'
#DynamoDbTables
  CustomerTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      AttributeDefinitions:
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: email
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TableName: customer
  ContextTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: N
        - AttributeName: did
          AttributeType: S
        - AttributeName: pn
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
        - AttributeName: did
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: pn-did-index
          KeySchema:
            - AttributeName: pn
              KeyType: HASH
            - AttributeName: did
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: did-id-index
          KeySchema:
            - AttributeName: did
              KeyType: HASH
            - AttributeName: id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TableName: context
      TimeToLiveSpecification:
        AttributeName: exp
        Enabled: true
  AppointmentTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      AttributeDefinitions:
        - AttributeName: s
          AttributeType: S
        - AttributeName: d
          AttributeType: N
        - AttributeName: did
          AttributeType: S
        - AttributeName: uid
          AttributeType: N
      KeySchema:
        - AttributeName: s
          KeyType: HASH
        - AttributeName: d
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: did-d-index
          KeySchema:
            - AttributeName: did
              KeyType: HASH
            - AttributeName: d
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: uid-d-index
          KeySchema:
            - AttributeName: uid
              KeyType: HASH
            - AttributeName: d
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TableName: appointment
      TimeToLiveSpecification:
        AttributeName: exp
        Enabled: true
  DepartmentTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      AttributeDefinitions:
        - AttributeName: c
          AttributeType: S
        - AttributeName: n
          AttributeType: S
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: c
          KeyType: HASH
        - AttributeName: n
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: id-index
          KeySchema:
            - AttributeName: id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TableName: department
#Sqs queues
  BotQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Ref BotQueueName
      VisibilityTimeout: 61
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt: [ BotDeadLetterQueue, Arn ]
        maxReceiveCount: 1
  BotDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Ref BotDlqName
  BotEventSourceMapping:
    Type: "AWS::Lambda::EventSourceMapping"
    Properties:
      BatchSize: 10
      Enabled: true
      EventSourceArn: !GetAtt [ BotQueue, Arn ]
      FunctionName: !Ref RegisterBotLambdaName
    DependsOn:
      - RegisterBotLambda
#Api Gateway
  BotApi:
    Type: 'AWS::ApiGateway::RestApi'
    Properties:
      EndpointConfiguration:
        Types:
          - REGIONAL
      Name:
        Ref: APIName
    DependsOn:
      - AdminLambdaAlias
  Authorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      RestApiId: !Ref BotApi
      Name: !Ref AuthorizerName
      Type: COGNITO_USER_POOLS
      IdentitySource: method.request.header.token
      ProviderARNs:
        - !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPool}
    DependsOn:
      - BotApi
#ApiResources
  AdminResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !GetAtt
        - BotApi
        - RootResourceId
      PathPart: admin
    DependsOn:
      - BotApi
  BotResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !GetAtt
        - BotApi
        - RootResourceId
      PathPart: bot
    DependsOn:
      - BotApi
  BotPostResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref BotResource
      PathPart: '{id}'
    DependsOn:
      - BotApi
  AuthResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: auth
    DependsOn:
      - AdminResource
  ServiceResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: service
    DependsOn:
      - AdminResource
  AdminsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: admins
    DependsOn:
      - AdminResource
  SpecialistResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: specialist
    DependsOn:
      - AdminResource
  DepartmentResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: department
    DependsOn:
      - AdminResource
  DepartmentDataResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref DepartmentResource
      PathPart: data
    DependsOn:
      - DepartmentResource
  DepartmentDataGetResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref DepartmentDataResource
      PathPart: '{customer}'
    DependsOn:
      - DepartmentDataResource
  DepartmentCreateResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref DepartmentResource
      PathPart: create
    DependsOn:
      - DepartmentResource
  EmailVerifyResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref BotApi
      ParentId: !Ref AdminResource
      PathPart: email-verify
    DependsOn:
      - AdminResource
#Methods
  AuthPost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref AuthResource
      HttpMethod: POST
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - AuthResource
  BotLambdaPost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref BotPostResource
      HttpMethod: POST
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref BotLambdaAlias, "/invocations" ] ]
    DependsOn:
      - BotPostResource
      - BotLambdaAlias
  EmailVerifyGet:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref EmailVerifyResource
      HttpMethod: GET
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - EmailVerifyResource
  ServicePost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref ServiceResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - ServiceResource
      - BotLambdaAlias
  ServicePut:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref ServiceResource
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - ServiceResource
      - BotLambdaAlias
  ServiceDelete:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref ServiceResource
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - ServiceResource
      - BotLambdaAlias
  SpecialistPost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref SpecialistResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - SpecialistResource
      - BotLambdaAlias
  SpecialistPut:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref SpecialistResource
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - SpecialistResource
      - BotLambdaAlias
  SpecialistDelete:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref SpecialistResource
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - SpecialistResource
      - BotLambdaAlias
  AdminsPost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref AdminsResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - AdminsResource
      - BotLambdaAlias
  AdminsDelete:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref AdminsResource
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - AdminsResource
      - BotLambdaAlias
  DepartmentPost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - DepartmentResource
  DepartmentUpdateWebhookPut:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentResource
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - DepartmentResource
  DepartmentCreatePost:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentCreateResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - DepartmentCreateResource
  DepartmentDataGet:
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentDataGetResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref Authorizer
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 300
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: "'*'"
      Integration:
        Type: AWS_PROXY
        IntegrationResponses:
          - StatusCode: 200
        IntegrationHttpMethod: POST
        Uri: !Join [ "", [ "arn:aws:apigateway:", !Ref Region, ":lambda:path/2015-03-31/functions/", !Ref AdminLambdaAlias, "/invocations" ] ]
    DependsOn:
      - DepartmentDataGetResource
#Options
  AuthOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref AuthResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  EmailVerifyOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref EmailVerifyResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  ServicePostOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref ServiceResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,PUT,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  SpecialistOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref SpecialistResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,PUT,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  AdminsOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref AdminsResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  DepartmentOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,PUT,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  DepartmentDataGetOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentDataGetResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
  DepartmentCreateOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      RestApiId: !Ref BotApi
      ResourceId: !Ref DepartmentCreateResource
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        Type: MOCK
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: 'Empty'
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
#Deployment
  AdminDeployment:
    Type: 'AWS::ApiGateway::Deployment'
    Properties:
      RestApiId: !Ref BotApi
      StageName:
        Ref: EnvironmentName
    DependsOn:
      - BotApi
      - AuthPost
      - EmailVerifyGet
      - BotLambdaPost
      - DepartmentDataGet
      - DepartmentCreatePost
      - DepartmentPost
      - DepartmentUpdateWebhookPut
      - ServicePost
#ApiGateway permission
  AdminApiPermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref AdminLambdaAlias
      Principal: apigateway.amazonaws.com
    DependsOn:
      - AdminDeployment
  BotApiPermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref BotLambdaAlias
      Principal: apigateway.amazonaws.com
    DependsOn:
      - AdminDeployment
  RegisterBotPermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref RegisterBotLambda
      Principal: apigateway.amazonaws.com
    DependsOn:
      - AdminDeployment
#Cognito User Pool
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Ref UserPoolName
      AutoVerifiedAttributes:
        - email
      EmailConfiguration:
        EmailSendingAccount: DEVELOPER
        From: !Ref VerifiedIdentityEmail
        SourceArn: !Join [ "", [ "arn:aws:ses:", !Ref Region, ":", !Ref AccountId, ":identity/", !Ref VerifiedIdentityEmail ] ]
      UsernameAttributes:
        - email
      LambdaConfig:
        PostConfirmation: !GetAtt PostSignUpPythonLambda.Arn
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: false
          Required: true
        - Name: phone_number
          AttributeDataType: String
          Mutable: false
          Required: true
  UserPoolClient:
    Type: "AWS::Cognito::UserPoolClient"
    Properties:
      ClientName: !Sub ${UserPoolName}-client
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      GenerateSecret: false
      UserPoolId: !Ref UserPool
      CallbackURLs:
        - !Join [ "", [ "https://appointer-ui-", !Ref AccountId, ".s3.", !Ref Region, ".amazonaws.com/html/login.html" ] ]
      SupportedIdentityProviders:
        - COGNITO
      AllowedOAuthFlows:
        - code
      AllowedOAuthFlowsUserPoolClient: True
      AllowedOAuthScopes:
        - phone
        - email
        - openid
  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Join [ "", [ !Ref DomainName, "-", !Ref AccountId ] ]
      UserPoolId: !Ref UserPool
#SsmParameters
  UserPoolParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Ref PoolIdParamName
      Tier: Standard
      Type: String
      Value: !Ref UserPool
  ClientUserPoolParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Ref ClientPoolIdParamName
      Tier: Standard
      Type: String
      Value: !Ref UserPoolClient
  BotUrlParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: bot_url
      Tier: Standard
      Type: String
      Value: !Join [ "", [ "https://", !Ref BotApi, ".execute-api.eu-central-1.amazonaws.com/dev/bot/" ] ]
    DependsOn:
      - BotApi
Outputs:
  BotApiId:
    Value: !Ref BotApi
  UserPoolClientId:
    Value: !Ref UserPoolClient

Parameters:
  AdminLambdaName:
    Type: String
    Default: adminLambda
  BotLambdaName:
    Type: String
    Default: appointerBotLambda
  PostSignUpLambdaName:
    Type: String
    Default: postSignUpPythonLambda
  RegisterBotLambdaName:
    Type: String
    Default: registerBotPythonLambda
  AdminLambdaAliasName:
    Type: String
    Default: adminLambdaAlias
  LayerName:
    Type: String
    Default: adminLayer
  LayerFileName:
    Type: String
    Default: bot-3d-layer.jar
  UiBucketName:
    Type: String
    Default: appointment-ui-bucket
  DeploymentBucket:
    Type: String
    Default: appointment-deployment-bucket
  LayerArtefact:
    Type: String
    Default: bot-3d-layer.jar
  AdminLambdaArtifact:
    Type: String
    Default: admin
  BotLambdaArtifact:
    Type: String
    Default: bot
  PostSignUpArtifact:
    Type: String
    Default: registration
  ArtifactSuff:
    Type: String
    Default: -0.0.1-SNAPSHOT.jar
  APIName:
    Type: String
    Default: appointer
  AuthorizerName:
    Type: String
    Default: appointerAuthorizer
  DomainName:
    Type: String
    Default: appointer
  BotQueueName:
    Type: String
    Default: botQueue
  BotDlqName:
    Type: String
    Default: botDlq
  UserPoolName:
    Type: String
    Default: AppointerUserPool
  PoolIdParamName:
    Type: String
    Default: user-pool-id
  ClientPoolIdParamName:
    Type: String
    Default: user-pool-client-id
  EnvironmentName:
    Type: String
    Default: dev
  Region:
    Type: String
    Default: eu-central-1
  AccountId:
    Type: String
    Default: 773974733061
  VerifiedIdentityEmail:
    Type: String
    Default: sergii.udaltsov@gmail.com